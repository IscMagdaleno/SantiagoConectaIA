@page "/tramites"
@inject NavigationManager NavManager
@using System.Text.Json
@using SantiagoConectaFront.Componentes.TramitesArea
@using SantiagoConectaFront.Shared 
@using SantiagoConectaIA.Share.Objects.OficinasModule
@using SantiagoConectaIA.Share.Objects.TramitesModule

<PageTitle>Trámites y Servicios</PageTitle>

<div class="min-h-screen bg-gray-50">
    @* ELIMINADO: <HeaderComponent /> *@

    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-blue-900 via-blue-800 to-blue-700 text-white py-16">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">
                    Trámites y Servicios
                </h1>
                <p class="text-xl text-blue-100 mb-8 max-w-3xl mx-auto">
                    Consulta todos los trámites disponibles en Santiago Papasquiaro.
                    Encuentra información detallada, requisitos y ubicaciones.
                </p>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-white border-b shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <!-- Search Bar -->
                <div class="relative flex-1 max-w-md">
                    @Icon.Search("absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5")
                    <input
                        type="text"
                        placeholder="Buscar trámites..."
                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        @bind="SearchTerm"
                        @bind:event="oninput"
                        @onkeyup="ApplyFilters"
                    />
                </div>

                <!-- Category Filter -->
                <div class="flex items-center gap-4">
                    <div class="relative">
                        @Icon.Filter("absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5")
                        <select
                            class="pl-10 pr-8 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white min-w-[200px]"
                            @bind="SelectedCategory">
                            <option value="0">Todas las categorías</option>
                            @foreach (var category in Categories)
                            {
                                <option value="@category.id">@category.name</option>
                            }
                        </select>
                    </div>

                    <!-- View Toggle -->
                    <div class="flex border border-gray-300 rounded-lg overflow-hidden">
                        <button
                            @onclick='() => ViewMode = "grid"'
                            class="@(ViewMode == "grid" ? "p-3 bg-blue-600 text-white" : "p-3 bg-white text-gray-600")"
                        >
                            @Icon.Grid2x2("w-5 h-5")
                        </button>
                        <button
                            @onclick='() => ViewMode = "list"'
                            class="@(ViewMode == "list" ? "p-3 bg-blue-600 text-white" : "p-3 bg-white text-gray-600")"
                        >
                            @Icon.List("w-5 h-5")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="container mx-auto px-4 py-8">
        @if (Loading)
        {
            <div class="flex justify-center items-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        }
        else
        {
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    @FilteredTramites.Count() trámite@(FilteredTramites.Count() != 1 ? "s" : "") encontrado@(FilteredTramites.Count() != 1 ? "s" : "")
                </h2>
            </div>

            @if (FilteredTramites.Any())
            {
                @if (ViewMode == "grid")
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @foreach (var tramite in FilteredTramites)
                        {
                            <TramiteCardComponent Tramite="tramite" />
                        }
                    </div>
                }
                else
                {
                    <div class="space-y-4">
                        @foreach (var tramite in FilteredTramites)
                        {
                            <TramiteListItemComponent Tramite="tramite" />
                        }
                    </div>
                }
            }
            else
            {
                <div class="text-center py-12">
                    @Icon.FileText("w-16 h-16 text-gray-400 mx-auto mb-4")
                    <h3 class="text-xl font-medium text-gray-600 mb-2">
                        No se encontraron trámites
                    </h3>
                    <p class="text-gray-500">
                        Intenta ajustar los filtros o términos de búsqueda
                    </p>
                </div>
            }
        }
    </div>

    @* ELIMINADO: <FooterComponent /> *@
</div>

@code {
    private List<Tramite> Tramites { get; set; } = new();
    private List<Tramite> FilteredTramites { get; set; } = new();
    private string SearchTerm { get; set; } = string.Empty;
    private int _selectedCategory = 0;
    private string ViewMode { get; set; } = "grid";
    private bool Loading { get; set; } = true;

    private int SelectedCategory
    {
        get => _selectedCategory;
        set
        {
            if (_selectedCategory != value)
            {
                _selectedCategory = value;
                ApplyFilters();
            }
        }
    }
    // Simulación de Categorías (se podría obtener de la base de datos o API)
    private readonly List<(int id, string name)> Categories = new()
    {
        (1, "Tránsito y Transporte"),
        (2, "Hacienda y Finanzas"),
        (3, "Desarrollo Urbano"),
        (4, "Registro Civil"),
        (5, "Servicios Públicos")
    };

    protected override async Task OnInitializedAsync()
    {
        // Simulamos la carga de datos
        await Task.Delay(1000); // Simula el delay de la API

        var mockTramites = new List<Tramite>
        {
            new Tramite
            {
                iIdTramite = 1,
                vchNombre = "Licencia de Conducir",
                nvchDescripcion = "Obtención de licencia de conducir para vehículos particulares",
                iIdCategoria = 1,
                bModalidadEnLinea = false,
                mCosto = 450.00m,
                dtFechaActualizacion = new DateTime(2024, 01, 15),
                Oficina = new Oficina { vchNombre = "Oficina de Tránsito" }
            },
            new Tramite
            {
                iIdTramite = 2,
                vchNombre = "Pago de Impuesto Predial",
                nvchDescripcion = "Pago anual del impuesto predial para propiedades en el municipio",
                iIdCategoria = 2,
                bModalidadEnLinea = true,
                mCosto = 0.00m,
                dtFechaActualizacion = new DateTime(2024, 01, 10),
                Oficina = new Oficina { vchNombre = "Tesorería Municipal" }
            },
            new Tramite
            {
                iIdTramite = 3,
                vchNombre = "Permiso de Construcción Menor",
                nvchDescripcion = "Permiso para construcciones menores y remodelaciones",
                iIdCategoria = 3,
                bModalidadEnLinea = false,
                mCosto = 850.00m,
                dtFechaActualizacion = new DateTime(2024, 01, 20),
                Oficina = new Oficina { vchNombre = "Desarrollo Urbano" }
            }
        };

        Tramites = mockTramites;
        FilteredTramites = Tramites;
        Loading = false;
    }

    private void ApplyFilters()
    {
        IEnumerable<Tramite> filtered = Tramites;

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            filtered = filtered.Where(t =>
                t.vchNombre.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                t.nvchDescripcion.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)
            );
        }

        if (SelectedCategory > 0)
        {
            filtered = filtered.Where(t => t.iIdCategoria == SelectedCategory);
        }

        FilteredTramites = filtered.ToList();
    }

    
    // Clase auxiliar para iconos (Mantenida por compatibilidad de código)
    public static class Icon
    {
        public static RenderFragment Search(string className) =>@<svg xmlns="http://www.w3.org/2000/svg" class="@className" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        public static RenderFragment Filter(string className) =>@<svg xmlns="http://www.w3.org/2000/svg" class="@className" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 3.5H2l8 10.5V22l4-4V14.5z"/></svg>;
        public static RenderFragment Grid2x2(string className) =>@<svg xmlns="http://www.w3.org/2000/svg" class="@className" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="8" x="2" y="2" rx="1"/><rect width="8" height="8" x="14" y="2" rx="1"/><rect width="8" height="8" x="2" y="14" rx="1"/><rect width="8" height="8" x="14" y="14" rx="1"/></svg>;
        public static RenderFragment List(string className) =>@<svg xmlns="http://www.w3.org/2000/svg" class="@className" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
        public static RenderFragment FileText(string className) =>@<svg xmlns="http://www.w3.org/2000/svg" class="@className" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><line x1="8" x2="16" y1="13" y2="13"/><line x1="8" x2="16" y1="17" y2="17"/><line x1="8" x2="12" y1="9" y2="9"/></svg>;
    }
}